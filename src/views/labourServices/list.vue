<template>  <el-main class="bg_white ">    <el-card class="box-card">      <!--<div slot="header" class="clearfix">-->        <template v-for="(item, i) in funList">          <el-button class="c_rela" v-if="item.key === 'export'" :key="i" type="primary" size="small" round :disabled="item.disabled" v-show="!item.isHide" @click="handleFun(item)">            {{ item.name }}            <input class="fileInput c_w c_h c_opacity" :class="!item.disabled && isExport ? '' : 'c_no_pointer'" type="file" @change="importExcel" />          </el-button>          <el-button v-else :key="i" type="primary" size="small" round :disabled="item.disabled" v-show="!item.isHide" @click="handleFun(item)">{{ item.name }}</el-button>        </template>      <!--</div>-->    </el-card>    <el-card>      <div class="table-header c_h">        <el-table          ref="headerTable"          class="c_h"          :data="tableHeaderData"          :row-key="tableHeaderParam.rowKey"          :expand-row-keys="tableHeaderParam.expandRowKeys"          size="small"          height="300"          highlight-current-row          @selection-change="headerSelectionChange"        >          <el-table-column type="selection" width="55"></el-table-column>          <template v-for="(item, i) in tableHeaderParam.list">            <el-table-column :key="i" :label="item.name" :prop="item.key"></el-table-column>          </template>          <el-table-column type="expand">            <template slot-scope="props">              <el-form label-position="left" inline class="demo-table-expand">                <template v-for="(item,i) in tableHeaderParam.detailList">                  <!--<el-form-item v-show="item.isUse" :label="item.name">-->                  <el-form-item :label="item.name">                    <!--<el-input size="small" :disabled="isHeaderDetailDisabled(props)" v-model="props.row[item.key]"></el-input>-->                    <el-input size="small" :disabled="isHeaderDetailDisabled || (props.row[tableHeaderParam.rowKey] !== headerTableSelectionData[tableHeaderParam.rowKey])" v-model="props.row[item.key]"></el-input>                  </el-form-item>                </template>              </el-form>            </template>          </el-table-column>        </el-table>      </div>    </el-card>    <el-card class="c_m_t_n">      <el-table        class="c_h"        size="small"        height="200"        :data="tableBodyData"      >        <template v-for="(item, i) in tableBodyParam.list">          <el-table-column :key="i" :label="item.name" :prop="item.key"></el-table-column>        </template>      </el-table>    </el-card>    <div class="table-footer-seat"></div>    <el-card class="c_m_t_n table-footer">      <el-form label-position="left" inline class="demo-table-expand">        <template v-for="(item, i) in footerParam.form">          <el-form-item :label="item.name">            <el-input size="small" :disabled="true" v-model="footerData[item.key]"></el-input>          </el-form-item>        </template>      </el-form>    </el-card>  </el-main></template><script>  import XLSX from 'xlsx'    export default {        name: "labourServices",      mixins: [],      data() {          return {            timer: undefined,            // 功能菜单            // -- [ 'select', 'edit', 'add', 'del', 'cancel', 'confirm', 'approval', 'joinApproval', 'dealtSelect', 'export']            funList: [              { name: '查询', type: 'primary', disabled: false, isHide: false, key: 'select', handle: 'selectHeader' },              { name: '修改', type: 'primary', disabled: false, isHide: false, key: 'edit', handle: 'editHeader' },              { name: '增加', type: 'primary', disabled: false, isHide: false, key: 'add', handle: 'addHeader' },              { name: '删除', type: 'primary', disabled: false, isHide: false, key: 'del', handle: 'delHeader' },              { name: '取消', type: 'primary', disabled: false, isHide: false, key: 'cancel', handle: 'cancelHeader' },              { name: '提交', type: 'primary', disabled: false, isHide: false, key: 'confirm', handle: 'confirmHeader' },              { name: '审批', type: 'primary', disabled: false, isHide: false, key: 'approval', handle: 'approvalHeader' },              { name: '联查审批情况', type: 'primary', disabled: false, isHide: false, key: 'joinApproval', handle: 'jointApprovalHeader' },              { name: '待办查询', type: 'primary', disabled: false, isHide: false, key: 'dealtSelect', handle: 'dealtSelectHeader' },              { name: '导入', type: 'primary', disabled: false, isHide: false, key: 'export', handle: 'exportHeader' },            ],            // api            api: {              // --- 接口              getData: '/service/GlLaborwage',              // --- 获取表头              getHeader: '/service/GlLaborwage',              // --- 获取表体              getBody: '/service/GlLaborwage',            },            // 表头参数            // -- 表头状态            headerState: 'select',            // -- 请求参数            //  --query:单据查询            //  --add:新增单据            //  --workflow:待办查询            //  --approve:审批单据            headerSearchData: {              action: 'query',              data: {}            },            // -- 表格参数            tableHeaderParam: {              list: [                // 单据编号		单据日期		项目			报销金额                // 经办人部门		经办人		附件张数			用途                // { name: '主键', key: 'cbillid', isUse: true },                // { name: '公司', key: 'pk_corp', isUse: true },                // { name: '部门', key: 'pk_dept', isUse: true },                // { name: '制单日期', key: 'doperatordate', isUse: true },                // { name: '单据日期', key: 'dbilldate', isUse: true },                // { name: '单据号', key: 'vbillno', isUse: true },                // { name: '单据状态', key: 'vbillstatus', isUse: true },                // { name: '单据类型', key: 'pk_billtype', isUse: true },                // { name: '业务类型', key: 'pk_busitype', isUse: true },                // { name: '制单人', key: 'voperatorid', isUse: true },                // { name: '制单时间', key: 'tmaketime', isUse: true },                // { name: '审核人', key: 'vapproveid', isUse: true },                // { name: '审核日期', key: 'dapprovedate', isUse: true },                // { name: '审核批语', key: 'vapprovenote', isUse: true },                // { name: '最后修改人', key: 'clastmodifier', isUse: true },                // { name: '最后修改时间', key: 'tlastmodifytime', isUse: true },                { name: '制单人', key: 'voperatorid', isUse: true },                { name: '部门', key: 'pk_dept', isUse: true },                { name: '项目', key: 'project', isUse: true },                { name: '附件张数', key: 'attachmentnum', isUse: true },                { name: '用途', key: 'purpose', isUse: true },                { name: '报销金额', key: 'amount', isUse: true },                { name: '单据主键', key: 'cbillid', isUse: true }              ],              detailList: [                { name: '单据主键', key: 'cbillid', isUse: false },                { name: '单据编号', key: 'vbillno', isUse: true },                { name: '交易类型', key: 'name', isUse: true },              ],              rowKey: 'cbillid',              expandRowKeys: []            },            // -- 表格列表数据            tableHeaderData: [{cbillid: 1}, {cbillid: 2}, {cbillid: 3}, {cbillid: 4}, {cbillid: 5}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}],            // -- 当前被选中表头项 | 表体请求参数            headerTableSelectionData: {},            // 表体参数            // -- 表格参数            tableBodyParam: {              list: [                //序号	姓名	银行卡号	开户行	联行号	应发	税率	税额	实发	备注 人员档案主键	人员银行账户主键                { name: '序号', key: 'rowno', isUse: true },                { name: '姓名', key: 'name', isUse: true },                { name: '银行卡号', key: 'banknum', isUse: true },                { name: '开户行', key: 'crtbank', isUse: true },                { name: '联行号', key: 'combinenum', isUse: true },                { name: '应发', key: 'should', isUse: true },                { name: '税率', key: 'ntaxrate', isUse: true },                { name: '税额', key: 'ntax', isUse: true },                { name: '实发', key: 'reality', isUse: true },                { name: '备注', key: 'memo', isUse: true },                // { name: '人员档案主键', key: 'pk_psndoc', isUse: false },                // { name: '人员银行账户主键', key: 'pk_bankacc', isUse: false},              ]            },            // -- 表格列表数据            tableBodyData: [{rowno: 11}, {rowno: 22}, {rowno: 33}, {rowno: 44}, {rowno: 55}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}],            // 表尾参数            // -- 表单参数            footerParam: {              form: [                { name: '录入人', key: 'voperatorid', isUse: true },                { name: '最终修改人', key: 'clastmodifier', isUse: true },                { name: '审核人', key: 'vapproveid', isUse: true },                { name: '单据状态', key: 'vbillstatus', isUse: true },              ]            },            // -- 表单数据            footerData: {              voperatorid: '录入人',              clastmodifier: '最终修改人',              vapproveid: '审核人',              vbillstatus: '单据状态',            },          }      },      computed: {          // 是否可以编辑详情卡片        isHeaderDetailDisabled(props) {          // [ 'select', 'edit', 'add', 'del', 'cancel', 'confirm', 'approval', 'joinApproval', 'dealtSelect', 'export']          return !['edit', 'add'].includes(this.headerState)        },        // 是否可以使用导入功能        isExport() {          // 未禁用          // 有唯一key值          // 属于编辑态和新增态          return this.headerTableSelectionData.cbillid && (['edit', 'add'].includes(this.headerState))        }      },      watch: {        headerState(val) {          switch (val) {            case 'select':              this.setFunAuth([ 'select', 'edit', 'add', 'del', 'approval', 'joinApproval', 'dealtSelect'])              break;            case 'edit':              this.setFunAuth([ 'cancel', 'confirm', 'export'])              break;            case 'add':              this.setFunAuth([ 'cancel', 'confirm', 'export'])              break;            case 'del':              this.setFunAuth([ 'select', 'edit', 'add', 'del','approval', 'joinApproval', 'dealtSelect'])              break;            case 'approval':              this.setFunAuth([ 'select', 'edit', 'add', 'del', 'approval', 'joinApproval', 'dealtSelect'])              break;            case 'joinApproval':              this.setFunAuth([ 'select', 'edit', 'add', 'del', 'approval', 'joinApproval', 'dealtSelect'])              break;            case 'dealtSelect':              this.setFunAuth([ 'select', 'edit', 'add', 'del', 'approval', 'joinApproval', 'dealtSelect'])              break;          }        }      },      methods: {          // 功能菜单事件        handleFun(item) {          let row = this.headerTableSelectionData;          if(['select', 'add', 'approval', 'joinApproval', 'dealtSelect'].includes(item.key)) {            this.headerState = item.key;            this[item.handle](row);            return          }          if (!row || !row[this.tableHeaderParam.rowKey]) {            return this.$message("请选择需要操作的单据");          }          if (item.key  !== 'export') {            this.headerState = item.key;          }          this[item.handle](row);        },        // 功能菜单权限控制        setFunAuth(list = [ 'select', 'edit', 'add', 'del', 'cancel', 'confirm', 'approval', 'joinApproval', 'dealtSelect', 'export']) {          // [ 'select', 'edit', 'add', 'del', 'cancel', 'confirm', 'approval', 'joinApproval', 'dealtSelect', 'export']          this.funList = this.funList.map(item => {            item.disabled = !list.includes(item.key)            return item          })        },        // 查询        selectHeader(row) {          this.headerSearchData = {            action: 'query',            data: {            }          }          this.getHeaderData()        },        // 修改        editHeader(row) {          // 展开详情          this.expandRow(row)          // 禁用其他操作          this.setFunAuth(['cancel', 'confirm', 'export'])        },        // 增加        addHeader(row) {          // 清空表头选中数据          this.headerTableSelectionData = {            [this.tableHeaderParam.rowKey]: 'add'          }          // 清空表体          this.tableBodyData = []          // 禁用其他操作          this.setFunAuth(['cancel', 'confirm', 'export'])          // 表头插入空数据          this.tableHeaderData.unshift({            [this.tableHeaderParam.rowKey]: 'add'          })          // 取消其他          this.clearSelection();          // 选中当前          this.selectionRow({            [this.tableHeaderParam.rowKey]: 'add'          }, true);          // 展开          this.expandRow({            [this.tableHeaderParam.rowKey]: 'add'          }, true);        },        // 删除        delHeader(row) {          // todo - ajax          // 刷新表头          this.getHeaderData()        },        // 取消        cancelHeader(row) {          this.expandRow(row, false)          // 取消权限控制          this.setFunAuth()          // 刷新表头          this.getHeaderData()        },        // 提交        confirmHeader(row) {          if (!['edit', 'add'].includes(this.headerState)){            return this.$message('没有需要提交的内容')          }          if (this.headerTableSelectionData[this.tableHeaderParam.rowKey] === 'add') {            this.headerTableSelectionData[this.tableHeaderParam.rowKey] = ''          }          let data = {            // 表头参数            ...this.headerTableSelectionData,            // 表体参数            detail: {              ...this.tableBodyData            }          }          this.$ajax.post(this.api.getHeader, {            action: 'add',            data: data          }, res => {            if (this.judgeValue(res)) {              this.$message('提交成功')              // 刷新表头              this.getHeaderData()              // 清空表体              this.tableBodyData = []            }            // 取消权限控制            this.setFunAuth()          })        },        // 审批        approvalHeader(row) {},        // 联查审批        jointApprovalHeader(row) {},        // 待办查询        dealtSelectHeader(row) {},        // 导入        exportHeader(data) {          if (!data.length) {            return          }          let list = []          for (let i = 0, j = data.length; i < j; i++) {            let obj = {};            obj.rowno = data[i]['序号']            obj.name = data[i]['姓名']            obj.banknum = data[i]['银行卡号']            obj.crtbank = data[i]['开户行']            obj.combinenum = data[i]['联行号']            obj.should = data[i]['应发']            obj.ntaxrate = data[i]['税率']            obj.ntax = data[i]['税额']            obj.reality = data[i]['实发']            obj.memo = data[i]['备注']            obj.pk_psndoc = data[i]['人员档案主键']            obj.pk_bankacc = data[i]['人员银行账户主键']            list.push(obj)          }          this.tableBodyData.push(...list)          this.$message('导入成功')        },        // 还原表头和表单        resetTable() {          this.headerState = 'select';          this.tableBodyData = []          // 取消权限控制          this.setFunAuth()        },        // ===== 表格操作        // 表头项展开事件 - 表头 ： cbillid        expandRow(row, isExpand = true) {          this.$refs.headerTable.toggleRowExpansion(row, isExpand);        },        // 表头项选中事件        selectionRow(row, isSelect = true) {          this.$refs.headerTable.toggleRowSelection(row, isSelect);        },        // 表头项清空选中事件        clearSelection() {          this.$refs.headerTable.clearSelection();        },        // 获取row的key值        getRowKeys(row) {          return row[this.tableHeaderParam.rowKey];        },        // 表头选中事件 - 实现单选操作        headerSelectionChange(val) {          const self = this;          // 如果是新增态， 禁用操作 | 取消新增          if (this.headerState === 'add') {            return          }          if (val[1]) {            this.selectionRow(val[0], false);            this.selectionRow(val[1], true);            this.expandRow(val[0], false);            this.expandRow(val[1], true);          }          this.headerState = 'select';          this.headerTableSelectionData = val[1] || val[0];          this.throttle(()=> {            self.getBodyData()          })        },        // ===== 数据请求        //请求表头内容        getHeaderData() {          // todo 表头请求信息待确定          let row = this.headerSearchData          this.$ajax.post(this.api.getHeader, row, res => {            if (this.judgeValue(res)) {              // this.tableHeaderData = res.data            }          })        },        //请求表体内容        getBodyData() {          let row = this.headerTableSelectionData          if (!row[this.tableHeaderParam.rowKey]) {            this.tableBodyData = []            return          }          this.$ajax.post(this.api.getBody, row, res => {            if (this.judgeValue(res)) {              this.tableHeaderData = res.data            }          })          this.tableBodyData = [{rowno: 111}, {rowno: 222}, {rowno: 333}, {rowno: 'p44'}, {rowno: 555}].map(item => {            item.rowno = row.cbillid + '---' + item.rowno            return item          })        },        // 节流        throttle(fun, duration = 1000) {          if (this.timer)clearTimeout(this.timer)          this.timer = setTimeout(() => {            if (fun)fun()          }, duration)        },        // 文件解析        importExcel(e) {          const self = this;          let files = e.target.files;          let fileReader = new FileReader();          let data,workbook,persons = []          fileReader.onload = function(ev) {            try {              data = ev.target.result              workbook = XLSX.read(data, {                type: "binary"              }) // 以二进制流方式读取得到整份excel表格对象            } catch (e) {              console.log("文件类型不正确");              return;            }            // 表格的表格范围，可用于判断表头是否数量是否正确            let fromTo = "";            // 遍历每张表读取            for (let sheet in workbook.Sheets) {              if (workbook.Sheets.hasOwnProperty(sheet)) {                fromTo = workbook.Sheets[sheet]["!ref"];                persons = persons.concat(                  XLSX.utils.sheet_to_json(workbook.Sheets[sheet])                );                // break; // 如果只取第一张表，就取消注释这行              }            }            self.exportHeader(persons)          };          // 以二进制方式打开文件          fileReader.readAsBinaryString(files[0]);        },        // 返回值判断        judgeValue(res, callback) {          if (res.success === 'Y') {            return true          } else {            this.$message(res.message)            return false          }        }      }    }</script><style scoped>  .fileInput{    position: absolute;    top: 0;    left: 0;    z-index: 100;    background: transparent;    color: transparent;  }.table-header{  /*min-height: 200px;*/}  .table-footer-seat{    height: 100px;  }  .table-footer{    min-height: 100px;  }  .table-footer{    position: fixed;    bottom: 0;    left: 0;    width: 100%;    z-index: 200;  }</style>