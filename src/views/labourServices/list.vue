<template>  <el-main class="bg_white">    <el-button class="goExit" type="primary" size="small" round @click="goExit">关闭</el-button>    <el-card class="box-card">      <!--<div slot="header" class="clearfix">-->      <template v-for="(item, i) in funList">        <el-button class="c_rela" v-if="item.key === 'export'" :key="i" type="primary" size="small" round :disabled="item.disabled" v-show="!item.isHide" @click="handleFun(item)">          {{ item.name }}          <input ref="fileInput" class="fileInput c_w c_h c_opacity" :class="!item.disabled && isExport ? '' : 'c_no_pointer'" type="file" @change="importExcel" />        </el-button>        <el-button v-else-if="item.key === 'card'" :key="i" type="primary" size="small" round :disabled="item.disabled" v-show="!item.isHide" @click="handleFun(item)">          {{ isCardTab ? '列表显示' : '卡片显示' }}        </el-button>        <el-button v-else :key="i" type="primary" size="small" round :disabled="item.disabled" v-show="!item.isHide" @click="handleFun(item)">{{ item.name }}</el-button>      </template>      <!--</div>-->    </el-card>    <div class="print-content">    <!--表头-->    <el-card>      <!--!!待办-->      <template v-if="headerState==='dealtSelect'">        <div v-show="isCardTab" class="">          <!--表头卡片-->          <el-form label-position="left" inline class="demo-table-expand">            <template v-for="(item,i) in tableHeaderParam.detailList_workflow">              <template v-if="item.key === 'vbillstatus'">                <el-form-item :label="item.name">                  <el-select style="width: 100px" size="small" readonly :disabled="true" v-model="headerTableSelectionData[item.key]">                    <el-option                      v-for="item in dataSource.vbillstatusListMap"                      :key="item.value"                      :label="item.label"                      :value="item.value">                    </el-option>                  </el-select>                </el-form-item>              </template>              <template v-else-if="item.key=== 'deptname'">                <el-form-item :label="item.name">                  <el-input style="width: 300px" size="small" :disabled="item.disabled || (headerState === 'edit') || isHeaderDetailDisabled" v-model="headerTableSelectionData[item.key]"></el-input>                </el-form-item>              </template>              <template v-else-if="item.key=== 'attachmentnum'">                <el-form-item :label="item.name">                  <el-input style="width: 80px" size="small" :disabled="item.disabled || (headerState === 'edit') || isHeaderDetailDisabled" v-model="headerTableSelectionData[item.key]"></el-input>                </el-form-item>              </template>              <template v-else-if="item.key=== 'operator'">                <el-form-item :label="item.name">                  <el-input style="width: 80px" size="small" :disabled="item.disabled || (headerState === 'edit') || isHeaderDetailDisabled" v-model="headerTableSelectionData[item.key]"></el-input>                </el-form-item>              </template>              <template v-else-if="item.key=== 'approver'">                <el-form-item :label="item.name">                  <el-input style="width: 80px" size="small" :disabled="item.disabled || (headerState === 'edit') || isHeaderDetailDisabled" v-model="headerTableSelectionData[item.key]"></el-input>                </el-form-item>              </template>              <template v-else-if="item.type === 'date'">                <el-form-item :label="item.name">                  <el-date-picker                    style="width: 130px;"                    :disabled="item.disabled || (headerState === 'edit') || isHeaderDetailDisabled"                    v-model="headerTableSelectionData[item.key]"                    size="small"                    type="date"                    placeholder="选择日期">                  </el-date-picker>                </el-form-item>              </template>              <template v-else-if="item.type === 'project'">                <el-form-item :label="item.name">                  <el-input                    size="small"                    readonly                    suffix-icon="el-icon-search"                    :disabled="item.disabled || isHeaderDetailDisabled"                    :class="(item.disabled || isHeaderDetailDisabled) ? 'c_no_pointer' : ''"                    v-model="headerTableSelectionData[item.key]"                    v-on:click.native="handleTree"></el-input>                </el-form-item>              </template>              <template v-else-if="item.type === 'def1name'">                <el-form-item :label="item.name">                  <el-input                    size="small"                    readonly                    suffix-icon="el-icon-search"                    :disabled="item.disabled || isHeaderDetailDisabled"                    :class="(item.disabled || isHeaderDetailDisabled) ? 'c_no_pointer' : ''"                    v-model="headerTableSelectionData[item.key]"                    v-on:click.native="handleDef1name"></el-input>                </el-form-item>              </template>              <template v-else>                <el-form-item :label="item.name">                  <el-input size="small" :disabled="item.disabled || (headerState === 'edit') || isHeaderDetailDisabled" v-model="headerTableSelectionData[item.key]"></el-input>                </el-form-item>              </template>            </template>          </el-form>        </div>        <div v-show="!isCardTab" class="table-header">          <!--表头列表-->          <el-table            ref="headerTable"            class="c_h"            :data="tableHeaderData"            :row-key="tableHeaderParam.rowKey"            :expand-row-keys="tableHeaderParam.expandRowKeys"            size="small"            height="300"            highlight-current-row            @selection-change="headerSelectionChange"          >            <el-table-column type="selection" width="55"></el-table-column>            <template v-for="(item, i) in tableHeaderParam.list_workflow">              <template v-if="item.key === 'vbillstatus'">                <el-table-column :key="i" :label="item.name" :prop="item.key">                  <template slot-scope="scope">                    {{ dataSource.vbillstatusList[scope.row[item.key]] }}                  </template>                </el-table-column>              </template>              <template v-else>                <el-table-column :key="i" :width="item.width" :label="item.name" :prop="item.key"></el-table-column>              </template>            </template>          </el-table>        </div>      </template>      <!--!!查询-->      <template v-else>        <div v-show="isCardTab" class="">          <!--表头卡片-->          <el-form label-position="left" inline class="demo-table-expand">            <template v-for="(item,i) in tableHeaderParam.detailList_query">              <template v-if="item.key === 'vbillstatus'">                <el-form-item :label="item.name">                  <el-select style="width: 100px" size="small" readonly :disabled="true" v-model="headerTableSelectionData[item.key]">                    <el-option                      v-for="item in dataSource.vbillstatusListMap"                      :key="item.value"                      :label="item.label"                      :value="item.value">                    </el-option>                  </el-select>                </el-form-item>              </template>              <template v-else-if="item.key=== 'deptname'">                <el-form-item :label="item.name">                  <el-input style="width: 300px" size="small" :disabled="item.disabled || (headerState === 'edit') || isHeaderDetailDisabled" v-model="headerTableSelectionData[item.key]"></el-input>                </el-form-item>              </template>              <template v-else-if="item.key=== 'attachmentnum'">                <el-form-item :label="item.name">                  <el-input style="width: 80px" size="small" :disabled="item.disabled || (headerState === 'edit') || isHeaderDetailDisabled" v-model="headerTableSelectionData[item.key]"></el-input>                </el-form-item>              </template>              <template v-else-if="item.key=== 'operator'">                <el-form-item :label="item.name">                  <el-input style="width: 80px" size="small" :disabled="item.disabled || (headerState === 'edit') || isHeaderDetailDisabled" v-model="headerTableSelectionData[item.key]"></el-input>                </el-form-item>              </template>              <template v-else-if="item.key=== 'approver'">                <el-form-item :label="item.name">                  <el-input style="width: 80px" size="small" :disabled="item.disabled || (headerState === 'edit') || isHeaderDetailDisabled" v-model="headerTableSelectionData[item.key]"></el-input>                </el-form-item>              </template>              <template v-else-if="item.type === 'date'">                <el-form-item :label="item.name">                  <el-date-picker                    style="width: 130px;"                    :disabled="item.disabled || (headerState === 'edit') || isHeaderDetailDisabled"                    v-model="headerTableSelectionData[item.key]"                    size="small"                    type="date"                    placeholder="选择日期">                  </el-date-picker>                </el-form-item>              </template>              <template v-else-if="item.type === 'project'">                <el-form-item :label="item.name">                  <el-input                    size="small"                    readonly                    suffix-icon="el-icon-search"                    :disabled="item.disabled || isHeaderDetailDisabled"                    :class="(item.disabled || isHeaderDetailDisabled) ? 'c_no_pointer' : ''"                    v-model="headerTableSelectionData[item.key]" v-on:click.native="handleTree"></el-input>                </el-form-item>              </template>              <template v-else-if="item.type === 'def1name'">                <el-form-item :label="item.name">                  <el-input                    size="small"                    readonly                    suffix-icon="el-icon-search"                    :disabled="item.disabled || isHeaderDetailDisabled"                    :class="(item.disabled || isHeaderDetailDisabled) ? 'c_no_pointer' : ''"                    v-model="headerTableSelectionData[item.key]" v-on:click.native="handleDef1name"></el-input>                </el-form-item>              </template>              <template v-else>                <el-form-item :label="item.name">                  <el-input size="small" :disabled="item.disabled || (headerState === 'edit') || isHeaderDetailDisabled" v-model="headerTableSelectionData[item.key]"></el-input>                </el-form-item>              </template>            </template>          </el-form>        </div>        <div v-show="!isCardTab" class="table-header c_h">          <!--表头列表-->          <el-table            ref="headerTable"            class="c_h"            :data="tableHeaderData"            :row-key="tableHeaderParam.rowKey"            :expand-row-keys="tableHeaderParam.expandRowKeys"            size="small"            height="250"            highlight-current-row            @selection-change="headerSelectionChange"          >            <el-table-column type="selection" width="55"></el-table-column>            <template v-for="(item, i) in tableHeaderParam.list_query">              <template v-if="item.key === 'vbillstatus'">                <el-table-column :key="i" :label="item.name" :prop="item.key">                  <template slot-scope="scope">                    {{ dataSource.vbillstatusList[scope.row[item.key]] }}                  </template>                </el-table-column>              </template>              <template v-else>                <el-table-column :key="i" :width="item.width" :label="item.name" :prop="item.key"></el-table-column>              </template>            </template>          </el-table>        </div>      </template>    </el-card>    <!--表体-->    <el-card class="c_m_t_n" style="min-height: 200px;">      <el-table        class="c_h"        size="small"        max-height="300"        show-summary        :summary-method="getSummaries"        :data="tableBodyData"      >        <template v-if="headerState==='add'" slot="empty">          <el-button            v-show="['add', 'edit'].includes(headerState)"            size="mini"            type="primary"            @click="tableBodyAdd">新增</el-button>        </template>        <template v-for="(item, i) in tableBodyParam.list">          <el-table-column v-if="item.key === 'rowno'" :key="i" :width="item.width" :label="item.name" :prop="item.key">            <template slot-scope="scope">              {{ scope.$index + 1}}            </template>          </el-table-column>          <el-table-column v-else :key="i" :width="item.width" :label="item.name" :prop="item.key"></el-table-column>        </template>        <el-table-column fixed="right" width="220" label="操作">          <template slot-scope="scope">              <!--v-show="['add', 'edit'].includes(headerState) && (scope.$index+1 === tableBodyData.length)"-->            <el-button              v-show="['add', 'edit'].includes(headerState)"              size="mini"              type="primary"              @click="tableBodyAdd(scope.$index, scope.row)">新增</el-button>            <el-button              v-show="['add', 'edit'].includes(headerState)"              size="mini"              type="primary"              @click="tableBodyEdit(scope.$index, scope.row)">编辑</el-button>            <el-button              v-show="['add', 'edit'].includes(headerState)"              size="mini"              type="danger"              @click="tableBodyDelete(scope.$index, scope.row)">删除</el-button>          </template>        </el-table-column>      </el-table>    </el-card>    </div>    <!--表尾-->    <div v-show="isCardTab" class="table-footer-seat"></div>    <!--<div v-show="isCardTab">-->    <!--<el-card class="c_m_t_n table-footer" >-->    <!--<el-form label-position="left" inline class="demo-table-expand">-->    <!--<template v-for="(item, i) in footerParam.form">-->    <!--<el-form-item :label="item.name">-->    <!--<el-input size="small" :disabled="false" v-model="footerData[item.key]"></el-input>-->    <!--</el-form-item>-->    <!--</template>-->    <!--</el-form>-->    <!--</el-card>-->    <!--</div>-->    <!--项目选择框-->    <el-dialog      title="项目"      :modal-append-to-body="false"      :append-to-body="false"      :visible.sync="projectParam.visible"    >      <div class="c_flex c_flex_between c_auto_y c_hidden" style="height: 300px;">        <!--show-checkbox-->        <div class="c_auto c_h" style="min-width: 230px;">          <el-tree            :data="projectParam.data"            node-key="JOBCLASS"            ref="tree"            accordion            getHalfCheckedKeys            highlight-current            :props="projectParam.defaultProps"            @node-click="handleTreeClick"          >            <span class="custom-tree-node" slot-scope="{ node, data }">              {{ data.JOBCLASS + '-' + data.JOBNAME}}            </span>          </el-tree>        </div>        <el-divider direction="vertical" style="height: 100%;" class="c_h c_m_l_10 c_m_r_10"></el-divider>        <div class="c_flex_1 c_hidden">          <el-form label-position="left" inline class="demo-table-expand">            <template v-for="(item,i) in projectParam.selectTableSearchList">              <el-form-item :label="item.name">                <el-input size="small" v-model="projectParam.selectTableSearchData[item.key]"></el-input>              </el-form-item>            </template>            <el-form-item>              <el-button type="primary" size="small" @click="getTreeDetailList">搜索</el-button>            </el-form-item>          </el-form>          <el-table            class="c_h"            size="small"            height="250"            :highlight-current-row="true"            :data="projectParam.detailData"            @row-click="projectTableClick"          >            <template v-for="(item, i) in projectParam.detailList">              <el-table-column :key="i" :label="item.name" :prop="item.key"></el-table-column>            </template>          </el-table>        </div>      </div>      <span slot="footer" class="dialog-footer">        <el-button size="small" @click="cancelTree">取 消</el-button>        <el-button type="primary" size="small" @click="confirmTree">确 定</el-button>      </span>    </el-dialog>    <!--指派财务-->    <def1name-select ref="def1nameSelect" @confirm="confirmDef1name"></def1name-select>    <!-- 查询条件弹框 -->    <query-select ref="querySelect" @confirm="confirmHeaderQuery"></query-select>    <!-- 审批条件弹框 -->    <approval-select ref="approvalSelect" @confirm="confirmHeaderApprove"></approval-select>    <!-- 表体新增，编辑弹框 -->    <table-body-select ref="tableBodySelect" @confirm="confirmBodyOpera"></table-body-select>  </el-main></template><script>  import XLSX from 'xlsx'  const json_project = require('../../../static/json/labourService/project')  import querySelect from './components/select'  import approvalSelect from './components/approval'  import def1nameSelect from './components/def1name'  import tableBodySelect from './components/tableBodySelect'  import { exportJsonToExcel } from '../../utils/excel'  export default {    name: "labourServices",    components: { querySelect, approvalSelect, def1nameSelect, tableBodySelect },    mixins: [],    data() {      return {        timer: undefined,        isCardTab: false,        // 功能菜单        // -- [ 'select', 'edit', 'add', 'del', 'cancel', 'confirm', 'approval', 'joinApproval', 'dealtSelect', 'export']        funList: [          { name: '查询', type: 'primary', disabled: false, isHide: false, key: 'select', handle: 'selectHeader' },          // { name: '修改', type: 'primary', disabled: false, isHide: false, key: 'edit', handle: 'editHeader' },          { name: '增加', type: 'primary', disabled: false, isHide: false, key: 'add', handle: 'addHeader' },          { name: '删除', type: 'primary', disabled: false, isHide: false, key: 'del', handle: 'delHeader' },          { name: '取消', type: 'primary', disabled: false, isHide: false, key: 'cancel', handle: 'cancelHeader' },          { name: '提交', type: 'primary', disabled: false, isHide: false, key: 'confirm', handle: 'confirmHeader' },          { name: '审批', type: 'primary', disabled: false, isHide: false, key: 'approval', handle: 'approvalHeader' },          // { name: '联查审批情况', type: 'primary', disabled: false, isHide: false, key: 'joinApproval', handle: 'jointApprovalHeader' },          { name: '待办查询', type: 'primary', disabled: false, isHide: false, key: 'dealtSelect', handle: 'dealtSelectHeader' },          { name: '导入', type: 'primary', disabled: false, isHide: false, key: 'export', handle: 'exportHeader' },          { name: '列表显示', type: 'primary', disabled: false, isHide: false, key: 'card', handle: 'tabCard' },          { name: '下载模板', type: 'primary', disabled: false, isHide: false, key: 'download', handle: 'download' },          { name: '打印', type: 'primary', disabled: false, isHide: false, key: 'print', handle: 'print' },        ],        // api        api: {          // todo --- 接口          // getData: '/api/service/GlLaborwage?userid=0001F8100000000000S1',          getData: '/service/GlLaborwage?userid=' + this.$util.getUrlParams('userid'),        },        dataSource: {          vbillstatusListMap: [            { value: 0, label: '审批不通过' },            { value: 1, label: '审核通过' },            { value: 2, label: '审批进行中' },            { value: 3, label: '提交' },            { value: 8,  label: '自由' }          ],          vbillstatusList: {            0: '审批不通过',            1: '审核通过',            2: '审批进行中',            3: '提交',            8:  '自由'          },        },        // 表头参数        // -- 表头状态        headerState: 'select',        // -- 请求参数        //  --query:单据查询        //  --add:新增单据        //  --workflow:待办查询        //  --approve:审批单据        headerSearchData: {          action: 'query',          data: {}        },        // -- 表格参数        tableHeaderParam: {          list: [],          list_query: [            { name: '单据编号', key: 'vbillno', isUse: true },            { name: '单据日期', key: 'dbilldate', isUse: true },            { name: '经办人', key: 'operator', isUse: true },            { name: '经办部门', key: 'deptname', width: 230, isUse: true },            { name: '项目', key: 'projectname', isUse: true },            { name: '指派财务', key: 'def1name', isUse: true },            { name: '附件张数', key: 'attachmentnum', isUse: true },            { name: '用途', key: 'purpose', isUse: true },            { name: '报销金额', key: 'amount', isUse: true },            { name: '单据状态', key: 'vbillstatus', isUse: true },          ],          list_workflow: [            { name: '单据编号', key: 'vbillno', width: 120,isUse: true },            { name: '单据日期', key: 'dbilldate', isUse: true },            { name: '经办人', key: 'operator', isUse: true },            { name: '经办部门', key: 'deptname', width: 220, isUse: true },            { name: '项目', key: 'projectname', isUse: true },            { name: '指派财务', key: 'def1name', isUse: true },            { name: '附件张数', key: 'attachmentnum', isUse: true },            { name: '用途', key: 'purpose', isUse: true },            { name: '报销金额', key: 'amount', isUse: true },            { name: '单据状态', key: 'vbillstatus', isUse: true },            { name: '发送人', key: 'sendman', isUse: true },            { name: '发送时间', key: 'senddate', width: 150, isUse: true },            // { name: '消息摘要', key: 'messagenote', isUse: true }          ],          detailList: [],          detailList_query: [            { name: '单据号', key: 'vbillno', disabled: true, isUse: false },            { name: '单据日期', key: 'dbilldate', type: 'date', isUse: true },            { name: '经办人', key: 'operator', disabled: true, isUse: true },            { name: '经办人部门', key: 'deptname', disabled: true, isUse: true },            { name: '项目', key: 'projectname', type: 'project', isUse: true },            { name: '指派财务', key: 'def1name', type: 'def1name', isUse: true },            { name: '报销金额', key: 'amount', isUse: true },            { name: '附件张数', key: 'attachmentnum', isUse: true },            { name: '审核人', key: 'approver', isUse: true },            { name: '单据状态', key: 'vbillstatus', isUse: true },            { name: '用途', key: 'purpose', isUse: true },          ],          detailList_workflow: [            { name: '单据号', key: 'vbillno', disabled: true, isUse: false },            { name: '单据日期', key: 'dbilldate', type: 'date', disabled: true, isUse: true },            { name: '经办人', key: 'operator', disabled: true, isUse: true },            { name: '经办人部门', key: 'deptname', disabled: true, isUse: true },            { name: '项目', key: 'projectname', type: 'project', disabled: true, isUse: true },            { name: '指派财务', key: 'def1name', type: 'def1name', disabled: true, isUse: true },            { name: '报销金额', key: 'amount', disabled: true, isUse: true },            { name: '附件张数', key: 'attachmentnum', disabled: true, isUse: true },            { name: '审核人', key: 'approver', disabled: true, isUse: true },            { name: '单据状态', key: 'vbillstatus', disabled: true, isUse: true },            { name: '发送人', key: 'sendman', disabled: true, isUse: true },            { name: '发送时间', key: 'senddate', disabled: true, isUse: true },            { name: '消息摘要', key: 'messagenote', disabled: true, isUse: true },            { name: '用途', key: 'purpose', disabled: true, isUse: true },          ],          rowKey: 'cbillid',          expandRowKeys: []        },        // -- 表格列表数据        tableHeaderData: [],        // -- 当前被选中表头项 | 表体请求参数        headerTableSelectionData: {},        // 表体参数        // -- 表格参数        tableBodyParam: {          list: [            //序号	姓名	银行卡号	开户行	联行号	应发	税率	税额	实发	备注 人员档案主键	人员银行账户主键            { name: '序号', key: 'rowno', isUse: true },            { name: '姓名', key: 'name', isUse: true },            { name: '职称', key: 'def2', isUse: true },            { name: '单位名称', key: 'def3', isUse: true },            { name: '项目', key: 'def4name', isUse: true },            { name: '身份证', key: 'idcard', width: 140, isUse: true },            { name: '银行卡号', key: 'banknum', width: 130, isUse: true },            { name: '开户行', key: 'crtbank', width: 260, isUse: true },            { name: '联行号', key: 'combinenum', width: 120, isUse: true },            { name: '手机号', key: 'def5', width: 120, isUse: true },            { name: '应发', key: 'should', isUse: true },            { name: '税额', key: 'ntax', isUse: true },            { name: '实发', key: 'reality', isUse: true },            { name: '工作内容及工作量', key: 'def6', width: 200, isUse: true },            { name: '备注', key: 'memo', width: 200, isUse: true },          ]        },        // -- 表格列表数据        tableBodyData: [],        // 表尾参数        // -- 表单参数        footerParam: {          form: [            // { name: '经办人', key: 'operator', isUse: true },            // { name: '最终修改人', key: 'clastmodifier', isUse: true },            // { name: '审核人', key: 'approver', isUse: true },            // { name: '单据状态', key: 'vbillstatus', isUse: true },          ]        },        // -- 表单数据        footerData: {          voperatorid: '录入人',          clastmodifier: '最终修改人',          vapproveid: '审核人',          vbillstatus: '单据状态',        },        // 项目选择参数        projectParam: {          visible: false,          defaultProps: {            children: 'children',            label: 'JOBNAME'          },          data: json_project,          // -- 详情表格参数          detailList: [            // {jobcode: "05"            //   jobname: "05"            //   pk_job}            { name: '项目编码', key: 'jobcode', isUse: true },            { name: '项目名称', key: 'jobname', isUse: true },            // { name: '组件', key: 'pk_job', isUse: true },          ],          // -- 详情表格数据          detailData: [],          // -- 选中tree数据          selectTreeData: {},          // 选中tree 下筛选条件参数          selectTableSearchList: [            { name: '项目名称', key: 'jobname', isUse: true },          ],          // 选中tree 下筛选数据          selectTableSearchData: {},          // -- 选中tree 下部门数据          selectTableData: {}        }      }    },    computed: {      // 是否可以编辑详情卡片      isHeaderDetailDisabled(props) {        // [ 'select', 'edit', 'add', 'del', 'cancel', 'confirm', 'approval', 'joinApproval', 'dealtSelect', 'export']        return !['edit', 'add'].includes(this.headerState)      },      // 是否可以使用导入功能      isExport() {        // 未禁用        // 有唯一key值        // 属于编辑态和新增态        return (['edit', 'add'].includes(this.headerState))      }    },    watch: {      headerState(val) {        switch (val) {          case 'select':            this.setFunAuth([ 'select', 'edit', 'add', 'del', 'joinApproval', 'dealtSelect', 'card', 'download', 'print'])            break;          case 'edit':            this.setFunAuth([ 'cancel', 'confirm', 'export', 'download', 'print'])            break;          case 'add':            this.setFunAuth([ 'cancel', 'confirm', 'export', 'download', 'print'])            break;          case 'joinApproval':            this.setFunAuth([ 'select', 'edit', 'add', 'del', 'approval', 'joinApproval', 'dealtSelect', 'card', 'download', 'print'])            break;          case 'dealtSelect':            this.setFunAuth([ 'select', 'add', 'cancel', 'approval', 'joinApproval', 'dealtSelect', 'card', 'download', 'print'])            break;        }      }    },    mounted() {      this.setFunAuth([ 'select', 'edit', 'add', 'del', 'joinApproval', 'dealtSelect', 'card', 'download', 'print'])      // this.headerState = 'select'      // this.selectHeader()    },    methods: {      // 功能菜单事件      handleFun(item) {        let row = this.headerTableSelectionData;        switch (item.key) {          case 'select':            this.headerState = item.key;            this[item.handle](row);            break;          case 'edit':            if (!row || !row[this.tableHeaderParam.rowKey]) {              return this.$message({ type: 'warn', message: '请选择需要操作的单据', duration: 1000 });            }            this.headerState = item.key;            this[item.handle](row);            break;          case 'add':            this.headerState = item.key;            this[item.handle](row);            break;          case 'cancel':            this[item.handle](row);            break;          case 'confirm':            this[item.handle](row);            break;          // case 'del':          //   this[item.handle](row);          //   break;          // case 'approval': // 审批          //   this[item.handle](row);          //   break;          // case 'joinApproval': // 联查审批情况          //   this[item.handle](row);          //   break;          case 'export':            if (this.headerState === 'add') {              this[item.handle](row);              return;            } else if(!row || !row[this.tableHeaderParam.rowKey]) {              return this.$message({ type: 'warn', message: '请选择需要操作的单据', duration: 1000 });            }            this[item.handle](row);            break;          case 'dealtSelect':            this.headerState = item.key;            this[item.handle](row);            break;          // case 'card':          //   this[item.handle](row);          //   break;          case 'download':            this[item.handle](row);            break;          case 'print':            this[item.handle](row);            break;          default:            if (!row || !row[this.tableHeaderParam.rowKey]) {              return this.$message({ type: 'warn', message: '请选择需要操作的单据', duration: 1000 });            }            this[item.handle](row);        }      },      // 功能菜单权限控制      setFunAuth(list = [ 'select', 'edit', 'add', 'del', 'cancel', 'confirm', 'approval', 'joinApproval', 'dealtSelect', 'export', 'card']) {        // [ 'select', 'edit', 'add', 'del', 'cancel', 'confirm', 'approval', 'joinApproval', 'dealtSelect', 'export']        this.funList = this.funList.map(item => {          item.disabled = !list.includes(item.key)          return item        })      },      // 查询      selectHeader(row) {        this.$refs.querySelect.open(row)      },      confirmHeaderQuery(data) {        // 返回列表显示        this.isCardTab = false        // 清空表体        this.tableBodyData = []        // 查询条件        this.headerSearchData = data        this.getHeaderData()      },      // 修改      editHeader(row) {        // 禁用其他操作        this.setFunAuth(['cancel', 'confirm', 'export'])        // 切换到卡片新增        this.isCardTab = true      },      // 增加      addHeader(row) {        // 取消其他选中        this.clearSelection();        // 清空表头选中数据        this.headerTableSelectionData = {          vbillstatus: 8        }        // 获取当前登陆人        this.getUser()        // 清空表体        this.tableBodyData = []        // 禁用其他操作        this.setFunAuth(['cancel', 'confirm', 'export'])        // 切换到卡片新增        this.isCardTab = true      },      // 删除      delHeader(row) {        const self = this        this.$confirm('确定要删除吗?', '删除提示', {          confirmButtonText: '确定',          cancelButtonText: '取消',          type: 'warning'        }).then(() => {          let data = {            action: 'del',            data: {              cbillid: row.cbillid            }          }          data.data = JSON.stringify(data.data)          this.$ajax.postform(this.api.getData, data, res => {            if (self.judgeValue(res)) {              self.$message({                type: 'success',                message: '删除成功!',                duration: 1000              });              // 返回列表状态              this.headerState = 'select'              // 返回列表显示              this.isCardTab = false              // 刷新表头              self.getHeaderData()            }          })        });      },      // 取消      cancelHeader(row) {        // 返回列表状态        this.headerState = 'select'        // 返回列表显示        this.isCardTab = false        // 取消权限控制        this.setFunAuth()        // 清空表体        this.tableHeaderData = []        this.tableBodyData = []        // 刷新表头        this.getHeaderData()      },      // 提交      confirmHeader(row) {        if (!['edit', 'add'].includes(this.headerState)){          return this.$message({ type: 'warn', message: '没有需要提交的内容', duration: 1000 });        }        let data = {          action: 'add',          data: {            // 表头参数            ...this.headerTableSelectionData,            // 表尾参数            // ...this.footerData,            // 表体参数            detail: [              ...(this.tableBodyData.map((item,index) => {                    item.rowno = index + 1;                    return item                  }                ))            ]          }        }        if(!data.data.attachmentnum) {          return this.$message({ type: 'warn', message: '请填写附件张数', duration: 1000 })        }        data.data = JSON.stringify(data.data)        this.$ajax.postform(this.api.getData, data, res => {          if (this.judgeValue(res)) {            this.$message({ type: 'success', message: '提交成功', duration: 1000 });            this.headerTableSelectionData = res.data[0]            // 修改状态为select            // 禁用表单            this.headerState = 'select'          }        })      },      // 审批      approvalHeader(row) {        this.$refs.approvalSelect.open(row)      },      confirmHeaderApprove(data) {        data.data = JSON.stringify(data.data)        this.$ajax.postform(this.api.getData, data, res => {          if (this.judgeValue(res)) {            // 返回列表状态            this.headerState = 'dealtSelect'            // 返回列表显示            this.isCardTab = false            // 刷新表头            this.dealtSelectHeader()            this.$refs.approvalSelect.close()          }        })      },      // 联查审批      jointApprovalHeader(row) {},      // 待办查询      dealtSelectHeader(row) {        this.headerState = 'dealtSelect'        // 返回列表显示        this.isCardTab = false        // 清空表体        this.tableBodyData = []        let data = {          action: 'workflow',          data: {            // checkman: ''          }        }        data.data = JSON.stringify(data.data)        this.$ajax.postform(this.api.getData, data, res => {          if (this.judgeValue(res)) {            this.$message({ type: 'success', message: '查询成功', duration: 1000 });            this.tableHeaderData = res.data || []          } else {            this.tableHeaderData = []          }        })      },      // 导入      exportHeader(data) {        if (!data.length) {          return        }        let list = []        for (let i = 0, j = data.length; i < j; i++) {          let obj = {};          // obj.rowno = data[i]['序号']          obj.name = data[i]['姓名']          obj.def2 = data[i]['职称']          obj.def3 = data[i]['单位名称']          if (this.headerTableSelectionData.pk_job) {            obj.def4name = this.headerTableSelectionData.projectname            obj.def4 = this.headerTableSelectionData.pk_job          }          obj.idcard = data[i]['身份证']          obj.banknum = data[i]['银行卡号']          obj.crtbank = data[i]['开户行']          obj.combinenum = data[i]['联行号']          obj.def5 = data[i]['手机号']          obj.should = data[i]['应发']          obj.ntax = data[i]['税额']          obj.reality = data[i]['实发']          obj.def6 = data[i]['工作内容及工作量']          obj.memo = data[i]['备注']          // obj.pk_psndoc = data[i]['人员档案主键']          // obj.pk_bankacc = data[i]['人员银行账户主键']          // if (!obj.rowno) { this.$message({ type: 'warn', message: '导入失败,请检查序号', duration: 1000 }); continue }          if (!obj.name) { this.$message({ type: 'warn', message: '导入失败,请检查姓名', duration: 1000 }); continue }          if (!obj.banknum) { this.$message({ type: 'warn', message: '导入失败,请检查银行卡号', duration: 1000 }); continue }          // if (!obj.crtbank) { this.$message({ type: 'warn', message: '导入失败,请检查开户行', duration: 1000 }); continue }          if (!obj.combinenum) { this.$message({ type: 'warn', message: '导入失败,请检查联行号', duration: 1000 }); continue }          if (!obj.should) { this.$message({ type: 'warn', message: '导入失败,请检查应发', duration: 1000 }); continue }          if (!obj.ntax) { this.$message({ type: 'warn', message: '导入失败,请检查税额', duration: 1000 }); continue }          if (!obj.reality) { this.$message({ type: 'warn', message: '导入失败,请检查实发', duration: 1000 }); continue }          list.push(obj)        }        this.tableBodyData.push(...list)        if (list.length) {          this.$message({ type: 'success', message: '导入成功', duration: 1000 })        }      },      // 卡片列表显示      tabCard() {        this.isCardTab = !this.isCardTab      },      // 下载模板      download() {        // let url = 'http://192.168.100.121:9000/download/demoV1.3.xlsx';        let url = window.location.origin + '/download/demoV1.3.xlsx';        window.open(url)      },      // 表体操作, 新增，编辑      tableBodyAdd(index, row) {        let data = {          def4name: this.headerTableSelectionData.projectname,          def4: this.headerTableSelectionData.pk_job        }        this.$refs.tableBodySelect.open('add', this.api.getData, data)      },      tableBodyEdit(index, row) {        let data = this.$util.deepCopy(row)        this.$refs.tableBodySelect.open('edit', this.api.getData, data, index)      },      confirmBodyOpera(type, data, i) {        switch (type) {          case 'add':            this.tableBodyData.push(data)            break          case 'edit':            let list = this.$util.deepCopy(this.tableBodyData)            list[i] = data            this.tableBodyData = list            break        }      },      // -- 删除      tableBodyDelete(index, row) {        // console.log(index, row);        this.tableBodyData.splice(index, 1)      },      // 表体合计      getSummaries(param) {        const { columns, data } = param;        const sums = [];        columns.forEach((column, index) => {          if (index === 0) {            sums[index] = '合计';            return;          }          if (![10, 11, 12].includes(index)) {            return;          }          const values = data.map(item => Number(item[column.property]));          if (!values.every(value => isNaN(value))) {            sums[index] = values.reduce((prev, curr) => {              const value = Number(curr);              if (!isNaN(value)) {                return prev + curr;              } else {                return prev;              }            }, 0);            sums[index] += ' 元';          } else {            sums[index] = '';          }          // 实发金额          if (index === 12 && this.headerState==='add') {            this.headerTableSelectionData.amount = parseFloat(sums[12]) || ''          }        });        return sums;      },      // ===== 表格操作      // 表头项展开事件 - 表头 ： cbillid      expandRow(row, isExpand = true) {        this.$refs.headerTable.toggleRowExpansion(row, isExpand);      },      // 表头项选中事件      selectionRow(row, isSelect = true) {        this.$refs.headerTable.toggleRowSelection(row, isSelect);      },      // 表头项清空选中事件      clearSelection() {        this.$refs.headerTable.clearSelection();      },      // 获取row的key值      getRowKeys(row) {        return row[this.tableHeaderParam.rowKey];      },      // 表头选中事件 - 实现单选操作      headerSelectionChange(val) {        const self = this;        // 如果是新增态， 禁用操作 | 取消新增        if (this.headerState === 'add') {          return        }        if (val[1]) {          this.selectionRow(val[0], false);          this.selectionRow(val[1], true);          this.expandRow(val[0], false);          this.expandRow(val[1], true);        }        // this.headerState = 'select';        this.headerTableSelectionData = val[1] || val[0];        this.throttle(()=> {          self.getBodyData()        })      },      // ===== 数据请求      //请求表头内容      getHeaderData() {        // 表体清空        this.tableBodyData = []        let row = this.$util.deepCopy(this.headerSearchData)        row.data = JSON.stringify(row.data)        this.$ajax.postform(this.api.getData, row, res => {          if (this.judgeValue(res)) {            this.tableHeaderData = res.data || []            this.$refs.querySelect.close()          }        })      },      //请求表体内容      getBodyData() {        let row = this.headerTableSelectionData        if (!row[this.tableHeaderParam.rowKey]) {          this.tableBodyData = []          return        }        let data = {          action: 'querydetail',          data: {            cbillid: row.cbillid          }        }        data.data = JSON.stringify(data.data)        this.$ajax.postform(this.api.getData, data, res => {          if (this.judgeValue(res)) {            this.tableBodyData = res.data || []          }        })      },      // 获取当前登录人      getUser() {        let data = {          action: 'current',          data: {}        }        data.data = JSON.stringify(data.data)        this.$ajax.postform(this.api.getData, data, res => {          if (this.judgeValue(res)) {            this.headerTableSelectionData = {              ...this.headerTableSelectionData,              operator: res.data[0].psnname,              deptname: res.data[0].deptname,              pk_deptdoc: res.data[0].pk_deptdoc            }          }        })      },      // 节流      throttle(fun, duration = 1000) {        if (this.timer)clearTimeout(this.timer)        this.timer = setTimeout(() => {          if (fun)fun()        }, duration)      },      // 文件解析      importExcel(e) {        const self = this;        let files = e.target.files;        let fileReader = new FileReader();        let data,workbook,persons = []        fileReader.onload = function(ev) {          try {            data = ev.target.result            workbook = XLSX.read(data, {              type: "binary"            }) // 以二进制流方式读取得到整份excel表格对象          } catch (e) {            console.log("文件类型不正确");            return;          }          // 表格的表格范围，可用于判断表头是否数量是否正确          let fromTo = "";          // 遍历每张表读取          for (let sheet in workbook.Sheets) {            if (workbook.Sheets.hasOwnProperty(sheet)) {              fromTo = workbook.Sheets[sheet]["!ref"];              persons = persons.concat(                XLSX.utils.sheet_to_json(workbook.Sheets[sheet])              );              // break; // 如果只取第一张表，就取消注释这行            }          }          self.exportHeader(persons)        };        // 以二进制方式打开文件        fileReader.readAsBinaryString(files[0]);      },      // 返回值判断      judgeValue(res, callback) {        if (res.success === 'Y') {          return true        } else {          this.$message({ type: 'warn', message: res.message, duration: 1000 })          return false        }      },      // 项目树操作      handleTree() {        this.projectParam.visible = true      },      // 项目树点击事件      handleTreeClick(data) {        let { JOBCLASS, JOBCODE, JOBNAME } = data        if (!data.children || !data.children.length) {          // 返回参数`          this.projectParam.selectData = { JOBCLASS, JOBCODE, JOBNAME }          this.getTreeDetailList()        } else {          this.projectParam.selectData = {}        }      },      // 获取项目树 下部门      getTreeDetailList() {        let { JOBCODE, JOBCLASS } = this.projectParam.selectData        let { jobname } = this.projectParam.selectTableSearchData        if (!JOBCLASS) {          return this.$message({ type: 'warn', message: '请选择到最后一级,以提高搜索效率', duration: 1000 })        }        let data = {          action: 'proj',          data: {            pk_jobclass: JOBCLASS,            jobcode: JOBCODE,            jobname          }        }        data.data = JSON.stringify(data.data)        this.$ajax.postform(this.api.getData, data, res => {          if (this.judgeValue(res)) {            this.projectParam.detailData = res.data || []          }        })      },      projectTableClick(row) {        this.projectParam.selectTableData = row      },      cancelTree() {        this.projectParam.selectTableData = {}        this.projectParam.visible = false      },      // -- 项目树提交      confirmTree() {        // const list = this.$refs.tree.getCheckedNodes()        // this.headerTableSelectionData.project = list[i].JOBCODE        if (!this.projectParam.selectTableData || !this.projectParam.selectTableData.jobcode) {          return this.$message({ type: 'warn', message: '请选择项目', duration: 1000 })        }        this.headerTableSelectionData.projectname = this.projectParam.selectTableData.jobname        this.headerTableSelectionData.pk_job = this.projectParam.selectTableData.pk_job        this.projectParam.visible = false      },      // 指派财务      handleDef1name() {        this.$refs.def1nameSelect.open(this.api.getData)      },      confirmDef1name(data) {        this.headerTableSelectionData = {          ...this.headerTableSelectionData,          def1name: data.username,          def1: data.userid,        }        this.$refs.def1nameSelect.close()      },      // 关闭页面      goExit() {        if (navigator.userAgent.indexOf("MSIE") > 0) {          if (navigator.userAgent.indexOf("MSIE 6.0") > 0) {            window.opener = null; window.close();          }          else {            window.open('', '_top'); window.top.close();          }        }        else if (navigator.userAgent.indexOf("Firefox") > 0) {          window.location.href = 'about:blank '; //火狐默认状态非window.open的页面window.close是无效的          //window.history.go(-2);        }        else {          window.opener = null;          window.open('', '_self', '');          window.close();        }      },      // 打印      print() {        const list = this.tableBodyData;        if (!list.length) {          return this.$message('当前打印表体数据为空')        }        const temp = [          { title: '序号', key: 'rowno' },          { title: '姓名', key: 'name' },          { title: '职称', key: 'def2' },          { title: '单位名称', key: 'def3' },          { title: '项目', key: 'def4name' },          { title: '身份证', key: 'idcard' },          { title: '银行卡号', key: 'banknum' },          { title: '开户行', key: 'crtbank' },          { title: '联行号', key: 'combinenum' },          { title: '手机号', key: 'def5' },          { title: '应发', key: 'should' },          { title: '税额', key: 'ntax' },          { title: '实发', key: 'reality' },          { title: '工作内容及工作量', key: 'def6' },          { title: '备注', key: 'memo' },        ]        const title = this.headerTableSelectionData.vbillno        exportJsonToExcel(temp , list, title + '.xlsx')      }    }  }</script><style scoped>  .fileInput{    position: absolute;    top: 0;    left: 0;    z-index: 100;    background: transparent;    color: transparent;  }  .table-header{    /*min-height: 200px;*/  }  .table-footer-seat{    height: 100px;  }  .table-footer{    min-height: 100px;  }  .table-footer{    position: fixed;    bottom: 0;    left: 0;    width: 100%;    z-index: 200;  }  .goExit{    position: absolute;    top: 40px;    right: 50px;    z-index: 100;  }</style>