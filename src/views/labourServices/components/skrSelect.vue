<template>  <!--部门 + 收款人选择框-->  <el-dialog    title="人员档案"    width="60%"    :modal-append-to-body="false"    :append-to-body="false"    :visible.sync="param.visible"  >    <div class="c_flex c_flex_between c_auto_y c_hidden" style="height: 300px;">      <!--show-checkbox-->      <div class="c_auto c_h" style="min-width: 230px;">        <el-tree          :data="param.data"          node-key="pk_deptdoc"          ref="tree"          accordion          getHalfCheckedKeys          highlight-current          :props="param.defaultProps"          :load="loadNode"          lazy          @node-click="handleTreeClick"        >            <span class="custom-tree-node" slot-scope="{ node, data }">              {{ data.deptname }}            </span>        </el-tree>      </div>      <el-divider direction="vertical" style="height: 100%;" class="c_h c_m_l_10 c_m_r_10"></el-divider>      <div class="c_flex_1 c_hidden">        <el-form label-position="left" inline class="demo-table-expand">          <el-form-item label="分类过滤" style="margin-right: 35px;">            <el-checkbox v-model="param.selectTableSearchData.isBm"></el-checkbox>          </el-form-item>          <template v-for="(item,i) in param.selectTableSearchList">            <el-form-item :label="item.name">              <el-input size="small" v-model="param.selectTableSearchData[item.key]"></el-input>            </el-form-item>          </template>          <el-form-item>            <el-button type="primary" size="small" @click="getTreeDetailList">搜索</el-button>          </el-form-item>        </el-form>        <el-table          class="c_h"          size="small"          height="250"          :highlight-current-row="true"          :data="param.detailData"          @row-click="projectTableClick"        >          <template v-for="(item, i) in param.detailList">            <el-table-column :key="i" :label="item.name" :prop="item.key"></el-table-column>          </template>        </el-table>      </div>    </div>    <span slot="footer" class="dialog-footer">        <el-button size="small" @click="cancel">取 消</el-button>        <el-button type="primary" size="small" @click="confirmTree">确 定</el-button>      </span>  </el-dialog></template><script>  export default {    name: "skrSelect",    data() {      return {        api: '',        // 部门选择参数        param: {          visible: false,          defaultProps: {            // deptcode: "01901"            // deptname: "游乐设施部公共"            // pk_deptdoc: "1004F810000000002VJD"            // pk_fathedept: "1004F810000000002VJA"            children: 'children',            label: 'deptname',            key: 'pk_deptdoc'          },          data: [],          // -- 详情表格参数          detailList: [            // pk_deptdoc: "1004F810000000002V1I"            // pk_psndoc: "1004F810000000002YNP"            // psncode: "00401"            // psnname: "戚月娣"            { name: '联系人编码', key: 'psncode', isUse: true },            { name: '联系人名称', key: 'psnname', isUse: true },          ],          // -- 详情表格数据          detailData: [],          // -- 选中tree数据          selectData: { pk_deptdoc: '' },          // 选中tree 下筛选条件参数          selectTableSearchList: [            { name: '联系人名称', key: 'psnname', isUse: true },          ],          // 选中tree 下筛选数据          selectTableSearchData: {            isBm: true          },          // -- 选中tree 下部门数据          selectTableData: {}        }      }    },    methods: {      // 项目树操作      open(api) {        this.api = api        // 默认开启报销部门过滤        this.param.selectTableSearchData.isBm = true        this.param.visible = true      },      cancel() {        this.param.selectTableData = {}        this.param.visible = false      },      // 获取部门列表      getBmList() {        let data = {          action: 'dept',          data: {            pk_fathedept: '0'          }        }        data.data = JSON.stringify(data.data)        this.$ajax.postform(this.api, data, res => {          if (this.judgeValue(res)) {            this.param.data = res.data || []          }        })      },      loadNode(node, resolve) {        let data = {          action: 'dept',          data: {            pk_fathedept: node.data.pk_deptdoc || "0"          }        }        data.data = JSON.stringify(data.data)        this.$ajax.postform(this.api, data, res => {          if (this.judgeValue(res)) {            let list = (res.data || []).map(item => {              item.leaf = item.children > 0              return item            })            resolve(list)          }        })      },      // 部门树点击事件      handleTreeClick(data) {        // deptcode: "00801"        // deptname: "条件保障部公共"        // pk_deptdoc: "1004F810000000002V1X"        let { pk_deptdoc, deptname } = data        this.param.selectData = { pk_deptdoc, deptname }        this.getTreeDetailList()      },      // 获取部门树 下人员      getTreeDetailList() {        let { pk_deptdoc } = this.param.selectData        let { psnname, isBm } = this.param.selectTableSearchData        // if (!pk_deptdoc) {        //   return          // return this.$message({ type: 'warn', message: '请选择到最后一级,以提高搜索效率', duration: 1000 })        // }        let data = {          action: 'psn',          data: {            pk_dept: isBm ? pk_deptdoc : '',            psn: psnname          }        }        data.data = JSON.stringify(data.data)        this.$ajax.postform(this.api, data, res => {          if (this.judgeValue(res)) {            this.param.detailData = res.data || []          }        })      },      projectTableClick(row) {        this.param.selectTableData = row      },      // -- 项目树提交      confirmTree() {        if (!this.param.selectTableData || !this.param.selectTableData.psncode) {          return this.$message({ type: 'warn', message: '请选择收款人', duration: 1000 })        }        // 部门        // deptcode: "00801"        // deptname: "条件保障部公共"        // pk_deptdoc: "1004F810000000002V1X"        // 收款人        // pk_deptdoc: "1004F810000000002V1I"        // pk_psndoc: "1004F810000000002YNP"        // psncode: "00401"        // psnname: "戚月娣"        let data = {          bmname: this.param.selectData.deptname,          bm: this.param.selectData.pk_deptdoc,          skrname: this.param.selectTableData.psnname,          skr: this.param.selectTableData.pk_psndoc,        };        this.cancel();        this.$emit('confirm', data)      },      // 返回值判断      judgeValue(res, callback) {        if (res.success === 'Y') {          return true        } else {          this.$message({ type: 'warn', message: res.message, duration: 1000 })          return false        }      },    }  }</script><style scoped></style>